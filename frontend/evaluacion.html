<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CreditoSys - Panel de Evaluación</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="styles.css" rel="stylesheet">
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading" id="loadingScreen">
        <div class="spinner"></div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification">
        <span id="notificationText"></span>
    </div>

    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <i class="fas fa-university"></i>
                <div>
                    <h1>CreditoSys</h1>
                    <small>Panel de Evaluación</small>
                </div>
            </div>
            <div class="user-info">
                <div>
                    <strong id="userName">Cargando...</strong>
                    <br>
                    <small id="userRole">Evaluador</small>
                </div>
                <div class="user-avatar" id="userAvatar">E</div>
                <div class="d-flex gap-1">
                    <a href="dashboard.html" class="btn btn-outline btn-sm">
                        <i class="fas fa-home"></i> Dashboard
                    </a>
                    <button class="btn btn-secondary btn-sm" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Salir
                    </button>
                </div>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <nav class="nav-tabs">
            <button class="nav-tab active" onclick="showSection('pendientes')">
                <i class="fas fa-clock"></i> Pendientes
            </button>
            <button class="nav-tab" onclick="showSection('validacion')">
                <i class="fas fa-check-circle"></i> Validación
            </button>
            <button class="nav-tab" onclick="showSection('scoring')">
                <i class="fas fa-calculator"></i> Scoring
            </button>
            <button class="nav-tab" onclick="showSection('revision')">
                <i class="fas fa-search"></i> Revisión Manual
            </button>
            <button class="nav-tab" onclick="showSection('reportes')">
                <i class="fas fa-chart-bar"></i> Reportes
            </button>
        </nav>

        <!-- Estadísticas del Evaluador -->
        <div class="dashboard-grid">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-hourglass-half"></i>
                </div>
                <div class="stat-number">12</div>
                <div class="stat-label">Pendientes</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-check"></i>
                </div>
                <div class="stat-number">8</div>
                <div class="stat-label">Evaluadas Hoy</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-percentage"></i>
                </div>
                <div class="stat-number">75%</div>
                <div class="stat-label">Tasa Aprobación</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-number">15 min</div>
                <div class="stat-label">Tiempo Promedio</div>
            </div>
        </div>

        <!-- Sección Pendientes -->
        <section id="pendientes" class="content-section active">
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-list"></i> Solicitudes Pendientes de Evaluación</h3>
                    <button class="btn btn-primary" onclick="actualizarPendientes()">
                        <i class="fas fa-sync-alt"></i> Actualizar
                    </button>
                </div>
                <div class="card-body">
                    <!-- Barra de búsqueda y paginación -->
                    <div class="d-flex justify-between align-center mb-2">
                        <input type="text" id="busquedaSolicitudes" class="form-input" placeholder="Buscar por cliente, ID o monto..." style="max-width: 250px;">
                        <div id="paginacionSolicitudes" class="d-flex align-center gap-1"></div>
                    </div>

                    <!-- Modal de detalle/evaluación -->
                    <div class="modal" id="modalDetalleSolicitud" style="display:none;position:fixed;z-index:9999;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.45);justify-content:center;align-items:center;">
                        <div class="modal-content" style="max-width:600px;width:95%;border-radius:12px;overflow:hidden;box-shadow:0 8px 32px rgba(0,0,0,0.25);background:#fff;">
                            <div class="modal-header" style="display:flex;align-items:center;justify-content:space-between;padding:20px 24px 10px 24px;">
                                <h3 style="margin:0;"><i class="fas fa-file-alt"></i> Detalle de Solicitud</h3>
                                <button class="modal-close" onclick="cerrarModalDetalleSolicitud()" style="background:none;border:none;font-size:1.5em;cursor:pointer;"><i class="fas fa-times"></i></button>
                            </div>
                            <div class="modal-body" id="detalleSolicitudBody" style="padding:24px;">
                                <!-- Aquí se cargan los datos dinámicamente -->
                            </div>
                            <div class="modal-footer" style="padding:16px;display:flex;justify-content:flex-end;gap:8px;">
                                <button class="btn btn-primary" id="btnAprobarSolicitud">Aprobar</button>
                                <button class="btn btn-danger" id="btnRechazarSolicitud">Rechazar</button>
                                <button class="btn btn-secondary" onclick="cerrarModalDetalleSolicitud()">Cerrar</button>
                            </div>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Cliente</th>
                                    <th>Monto</th>
                                    <th>Fecha Solicitud</th>
                                    <th>Estado</th>
                                    <th>Prioridad</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>#004</td>
                                    <td>Ana Torres</td>
                                    <td>S/ 50,000</td>
                                    <td>21/05/2025</td>
                                    <td><span class="badge status-pendiente">Documentos Subidos</span></td>
                                    <td><span class="badge" style="background: #ff6b6b; color: white;">Alta</span></td>
                                    <td>
                                        <button class="btn btn-primary btn-sm" onclick="iniciarEvaluacion('004')">
                                            <i class="fas fa-play"></i> Evaluar
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>#005</td>
                                    <td>Carlos Mendoza</td>
                                    <td>S/ 25,000</td>
                                    <td>20/05/2025</td>
                                    <td><span class="badge status-revision">En Validación</span></td>
                                    <td><span class="badge" style="background: #ffa726; color: white;">Media</span></td>
                                    <td>
                                        <button class="btn btn-success btn-sm" onclick="continuarEvaluacion('005')">
                                            <i class="fas fa-arrow-right"></i> Continuar
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>#006</td>
                                    <td>María Fernández</td>
                                    <td>S/ 15,000</td>
                                    <td>19/05/2025</td>
                                    <td><span class="badge status-pendiente">Nueva</span></td>
                                    <td><span class="badge" style="background: #4caf50; color: white;">Baja</span></td>
                                    <td>
                                        <button class="btn btn-primary btn-sm" onclick="iniciarEvaluacion('006')">
                                            <i class="fas fa-play"></i> Evaluar
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- Sección Validación de Documentos -->
        <section id="validacion" class="content-section">
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-file-check"></i> Validación de Documentos - Solicitud <span id="numSolicitudValidacion"></span></h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-2">
                            <h4>Información del Cliente</h4>
                            <div class="card">
                                <div class="card-body" id="infoClienteValidacion">
                                    <!-- Aquí se insertan los datos reales del cliente -->
                                </div>
                            </div>
                        </div>
                        <div class="col-2">
                            <h4>Documentos a Validar</h4>
                            <div id="docsAValidar">
                                <!-- Aquí se insertan los documentos dinámicamente -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Sección Cálculo de Scoring -->
        <section id="scoring" class="content-section">
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-calculator"></i> Cálculo de Score Crediticio - Solicitud #004</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-2">
                            <!-- Configuración de Ponderaciones según UML -->
                            <div class="card">
                                <div class="card-header">
                                    <h4>Ponderaciones (Según UML)</h4>
                                </div>
                                <div class="card-body">
                                    <div class="form-group">
                                        <label>Historial Crediticio</label>
                                        <input type="range" class="form-input" min="0" max="100" value="40" id="pesoHistorial" onchange="updateScoring()">
                                        <span id="pesoHistorialValue">40%</span>
                                    </div>
                                    <div class="form-group">
                                        <label>Ingresos vs Deuda</label>
                                        <input type="range" class="form-input" min="0" max="100" value="30" id="pesoIngresos" onchange="updateScoring()">
                                        <span id="pesoIngresosValue">30%</span>
                                    </div>
                                    <div class="form-group">
                                        <label>Activos</label>
                                        <input type="range" class="form-input" min="0" max="100" value="20" id="pesoActivos" onchange="updateScoring()">
                                        <span id="pesoActivosValue">20%</span>
                                    </div>
                                    <div class="form-group">
                                        <label>Comportamiento</label>
                                        <input type="range" class="form-input" min="0" max="100" value="10" id="pesoComportamiento" onchange="updateScoring()">
                                        <span id="pesoComportamientoValue">10%</span>
                                    </div>
                                    <small>Total: <span id="totalPonderacion">100%</span></small>
                                </div>
                            </div>
                        </div>
                        <div class="col-2">
                            <!-- Resultado del Scoring -->
                            <div class="card">
                                <div class="card-header">
                                    <h4>Score Calculado</h4>
                                </div>
                                <div class="card-body text-center">
                                    <div class="score-circle">
                                        <div class="score-text" id="scoreCalculado">82</div>
                                    </div>
                                    <h4>Score: <span id="clasificacionScore">Excelente</span></h4>
                                    <div class="progress">
                                        <div class="progress-bar" style="width: 82%" id="barraScore"></div>
                                    </div>
                                    
                                    <!-- Desglose del Score -->
                                    <div class="mt-3">
                                        <h5>Desglose:</h5>
                                        <p>Historial: <span id="puntajeHistorial">85</span> pts</p>
                                        <p>Ingresos: <span id="puntajeIngresos">90</span> pts</p>
                                        <p>Activos: <span id="puntajeActivos">75</span> pts</p>
                                        <p>Comportamiento: <span id="puntajeComportamiento">80</span> pts</p>
                                    </div>

                                    <!-- Decisión Automática -->
                                    <div class="card mt-3" style="background: rgba(76, 175, 80, 0.1);">
                                        <div class="card-body">
                                            <h5><i class="fas fa-robot"></i> Decisión Automática</h5>
                                            <p><strong>APROBACIÓN AUTOMÁTICA</strong></p>
                                            <p>Score ≥ 70: Cumple criterios</p>
                                            <p>Monto recomendado: S/ 50,000</p>
                                            <p>Tasa sugerida: 11.5% anual</p>
                                        </div>
                                    </div>

                                    <div class="d-flex gap-1 mt-3">
                                        <button class="btn btn-success" onclick="aprobarAutomatico()">
                                            <i class="fas fa-check"></i> Aprobar
                                        </button>
                                        <button class="btn btn-warning" onclick="enviarRevisionManual()">
                                            <i class="fas fa-user"></i> Revisión Manual
                                        </button>
                                
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Sección Revisión Manual -->
        <section id="revision" class="content-section">
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-user-check"></i> Revisión Manual - Solicitud #005</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-3">
                            <div class="card">
                                <div class="card-header">
                                    <h4>Información Completa</h4>
                                </div>
                                <div class="card-body">
                                    <p><strong>Cliente:</strong> <span id="revCliente">-</span></p>
                                    <p><strong>Score Automático:</strong> <span id="revScore">-</span></p>
                                    <p><strong>Monto Solicitado:</strong> S/ <span id="revMonto">-</span></p>
                                    <p><strong>Monto Recomendado:</strong> S/ <span id="revMontoRecomendado">-</span></p>
                                    <p><strong>Ingresos Mensuales:</strong> S/ <span id="revIngresos">-</span></p>
                                    <p><strong>Ratio Deuda/Ingreso:</strong> <span id="revRatio">-</span></p>
                                    <p><strong>Historial:</strong> <span id="revHistorial">-</span></p>
                                </div>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="card">
                                <div class="card-header">
                                    <h4>Decisión Manual</h4>
                                </div>
                                <div class="card-body">
                                    <div class="form-group">
                                        <label>Decisión</label>
                                        <select class="form-select" id="decisionManual">
                                            <option value="">Seleccionar decisión</option>
                                            <option value="aprobar">Aprobar</option>
                                            <option value="rechazar">Rechazar</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Monto Aprobado (S/)</label>
                                        <input type="number" class="form-input" id="montoManual" value="20000">
                                    </div>
                                    <div class="form-group">
                                        <label>Tasa de Interés (%)</label>
                                        <input type="number" class="form-input" id="tasaManual" value="13.5" step="0.1">
                                    </div>
                                    <div class="form-group">
                                        <label>Observaciones</label>
                                        <textarea class="form-input" id="observacionesManual" rows="4" placeholder="Justificación de la decisión..."></textarea>
                                    </div>
                                    <button class="btn btn-primary btn-block" onclick="guardarDecisionManual()">
                                        <i class="fas fa-save"></i> Guardar Decisión
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Sección Reportes -->
        <section id="reportes" class="content-section">
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-chart-bar"></i> Reportes de Evaluación</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-2">
                            <div class="card">
                                <div class="card-body text-center">
                                    <h4 id="reporteEvaluacionesMes">-</h4>
                                    <p>Evaluaciones este mes</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-2">
                            <div class="card">
                                <div class="card-body text-center">
                                    <h4 id="reporteAprobaciones">-</h4>
                                    <p>Aprobaciones</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-2">
                            <div class="card">
                                <div class="card-body text-center">
                                    <h4 id="reporteTasaAprobacion">-</h4>
                                    <p>Tasa de aprobación</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center mt-3">
                        <button class="btn btn-primary" onclick="generarReporteCompleto()">
                            <i class="fas fa-file-pdf"></i> Generar Reporte Completo
                        </button>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="script.js"></script>
    <script src="evaluador.js"></script>
    <script>
        // Funciones específicas del panel de evaluación
        
        function updateScoring() {
            // Actualizar valores de ponderación
            const historial = document.getElementById('pesoHistorial').value;
            const ingresos = document.getElementById('pesoIngresos').value;
            const activos = document.getElementById('pesoActivos').value;
            const comportamiento = document.getElementById('pesoComportamiento').value;
            
            document.getElementById('pesoHistorialValue').textContent = historial + '%';
            document.getElementById('pesoIngresosValue').textContent = ingresos + '%';
            document.getElementById('pesoActivosValue').textContent = activos + '%';
            document.getElementById('pesoComportamientoValue').textContent = comportamiento + '%';
            
            const total = parseInt(historial) + parseInt(ingresos) + parseInt(activos) + parseInt(comportamiento);
            document.getElementById('totalPonderacion').textContent = total + '%';
            
            // Recalcular score
            calcularScoreRealTime();
        }
        
        function aprobarAutomatico() {
            showNotification('Solicitud aprobada automáticamente', 'success');
        }
        
        function enviarRevisionManual() {
            showNotification('Enviando a revisión manual...', 'info');
            showSection('revision');
        }
        
        function simularEscenarios() {
            showNotification('Abriendo simulador de escenarios...', 'info');
        }
        
        function guardarDecisionManual() {
            const decision = document.getElementById('decisionManual').value;
            if (!decision) {
                showNotification('Debe seleccionar una decisión', 'error');
                return;
            }
            
            showNotification('Decisión guardada exitosamente', 'success');
        }
        
        function generarNuevoEscenario() {
            showNotification('Generando nuevo escenario...', 'info');
        }
        
        function actualizarPendientes() {
            showNotification('Actualizando lista de pendientes...', 'info');
        }
        
        function verDocumento(tipo) {
            showNotification(`Abriendo documento: ${tipo}`, 'info');
        }
        
        // Inicializar scoring cuando se carga
        document.addEventListener('DOMContentLoaded', function() {
            loadUserData();
           
        });
    </script>
</body>
</html>